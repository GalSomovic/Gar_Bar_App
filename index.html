<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gal and Bar App</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="ffc8fc">
    <!--    <link rel="apple-touch-icon" href="/custom_icon.png">-->
    <link href="style.css" rel="stylesheet">
</head>
<body>
<div class="cot">
    <div class="log">
        <h1>Gal's and Bar's Website</h1>
        <form class="main" style="margin: auto;" id="contactForm">
            <label for="fgal">gal spent:</label><br><br>
            <input type="number" pattern="\d*" onfocus="this.value=''" value="0" id="fgal" name="fgal">
            <button type="button" id="submit_gal">ADD</button>
            <br>
            <br><br><br>
            <label for="fbar">bar spent:</label><br><br>
            <input type="number" pattern="\d*" onfocus="this.value=''" value="0" id="fbar" name="fbar">
            <button type="button" id="submit_bar">ADD</button>
        </form>
        <br>
        <br>
        <br>
        <label id="updates_log">Nothing happend since you logged in</label>
        <br>
        <br>
        <button id="info">get info</button>
    </div>
</div>
<script type="module">
    // Import the functions you need from the SDKs you need
    import {initializeApp} from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
    import {
        getDatabase,
        ref,
        child,
        push,
        update,
        get
    } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDQFsC4HP_c8toeKkOZzYRWTfnUXudLMXE",
        authDomain: "gal-and-bar-app.firebaseapp.com",
        databaseURL: "https://gal-and-bar-app-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gal-and-bar-app",
        storageBucket: "gal-and-bar-app.appspot.com",
        messagingSenderId: "302627408397",
        appId: "1:302627408397:web:0b3a48b400909b96982344"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    class Record {
        constructor(person, amount) {
            this.preson = person;
            this.amount = amount;
        }

        submit() {
            if (this.preson === 0) {
                var val = 0;
                const dbRef = ref(getDatabase());
                get(child(dbRef, `gals_debt/amount`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        val = parseFloat(this.amount) + parseFloat(snapshot.val());

                    } else {
                        val = parseFloat(this.amount);
                    }
                    const postData = {
                        amount: val
                    };
                    const newPostKey = push(child(ref(database), 'posts')).key;
                    const updates = {};
                    updates['/gals_debt/'] = postData;
                    update(ref(database), updates);
                });
            } else {
                var val = 0;
                const dbRef = ref(getDatabase());
                get(child(dbRef, `bars_debt/amount`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        val = parseFloat(this.amount) + parseFloat(snapshot.val());

                    } else {
                        val = parseFloat(this.amount);
                    }
                    const postData = {
                        amount: val
                    };
                    const newPostKey = push(child(ref(database), 'posts')).key;
                    const updates = {};
                    updates['/bars_debt/'] = postData;
                    update(ref(database), updates);
                });
            }
        }
    }

    document.getElementById('submit_gal').addEventListener('click', submitGal);
    document.getElementById('submit_bar').addEventListener('click', submitBal);
    document.getElementById('info').addEventListener('click', update_det);

    function get_fd(id) {
        return document.getElementById(id).value;
    }

    // function update_det() {
    //     const dbRef = ref(getDatabase());
    //     get(child(dbRef, `bars_debt/amount`)).then((bar_d) => {
    //         if (bar_d.exists()) {
    //             get(child(dbRef, `gal_debt/amount`)).then((gal_d) => {
    //                 if (gal_d.exists()) {
    //                     if ((bar_d.val()) > (gal_d.val())) {
    //                         let sum_per_person = ((bar_d.val()) + (gal_d.val())) / 2;
    //                         let gal_deb = sum_per_person - (gal_d.val());
    //                         document.getElementById('updates_log').innerHTML = "gal owes bar " + gal_deb;
    //                     } else if ((gal_d.val()) > (bar_d.val())) {
    //                         let sum_per_person = ((bar_d.val()) + (gal_d.val())) / 2;
    //                         let bar_deb = sum_per_person - (bar_d.val());
    //                         document.getElementById('updates_log').innerHTML = "bar owes gal " + bar_deb;
    //                     } else {
    //                         document.getElementById('updates_log').innerHTML = "you are equal";
    //                     }
    //                 } else {
    //                     let sum_per_person = ((bar_d.val())) / 2;
    //                     document.getElementById('updates_log').innerHTML = "gal owes bar " + sum_per_person;
    //                 }
    //             });
    //         } else {
    //             get(child(dbRef, `bars_debt/amount`)).then((gal_d) => {
    //                 let sum_per_person = ((gal_d.val())) / 2;
    //                 document.getElementById('updates_log').innerHTML = "bar owes gal " + sum_per_person;
    //             });
    //         }
    //     });
    // }
    function update_det() {
        const dbRef = ref(getDatabase());
        const newPostKey = push(child(ref(database), 'posts')).key;
        get(child(dbRef, `bars_debt/amount`)).then((bar_d) => {
            get(child(dbRef, `gals_debt/amount`)).then((gal_d) => {
                console.log(bar_d.val());
                console.log(gal_d.val());
                let spent_sum = (gal_d.val() + bar_d.val()) / 2;
                if (gal_d.val() > bar_d.val()) {
                    let temp1 = spent_sum - bar_d.val();
                    document.getElementById('updates_log').innerHTML = "bar owes gal " + temp1;
                } else if (bar_d.val() > gal_d.val()) {
                    let temp2 = spent_sum - gal_d.val();
                    document.getElementById('updates_log').innerHTML = "gal owes bar " + temp2;
                } else {
                    document.getElementById('updates_log').innerHTML = "you are even";
                }
            });
        });
    }

    function submitGal() {
        let fgal = get_fd('fgal');
        document.getElementById('fgal').value = '0';
        const gal_rec = new Record(0, fgal);
        gal_rec.submit();
        let i = 0;
        while (i < 5) {
            i++;
        }
    }

    function submitBal() {
        let fgal = get_fd('fbar');
        document.getElementById('fbar').value = '0';
        const gal_rec = new Record(1, fgal);
        gal_rec.submit();
        let i = 0;
        while (i < 5) {
            i++;
        }
    }

</script>
</body>
</html>